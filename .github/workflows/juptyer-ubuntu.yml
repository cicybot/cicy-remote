name: Jupyter Ubuntu

on:
  workflow_dispatch:
  push:
    branches:
      - JupyterUbuntu

jobs:
  JupyterUbuntu:
    runs-on: ubuntu-latest
#    container:
#      image: ghcr.io/cicybot/ubuntu-vnc:1.0.1
    timeout-minutes: 3600

    steps:
      - name: Get System Info
        run: |
          curl api.myip.com
          free -m
          df -h

      - name: Update APT
        run: sudo apt-get update

      - name: Prevent service auto-start
        run: |
          echo -e '#!/bin/sh\nexit 101' | sudo tee /usr/sbin/policy-rc.d >/dev/null
          sudo chmod +x /usr/sbin/policy-rc.d

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Disable systemctl hooks
        run: bash .github/workflows/scripts/disable-systemctl.sh

      - name: Pre-create system users
        run: bash .github/workflows/scripts/precreate-users.sh

      - name: Install Desktop and VNC Server
        run: bash .github/workflows/scripts/install-desktop-vnc.sh

      - name: Validate system users and tmpfiles
        run: bash .github/workflows/scripts/validate-tmpfiles.sh

      - name: Re-enable service start
        run: bash .github/workflows/scripts/reenable-services.sh

      - name: Configure VNC Server
        run: |
          mkdir -p ~/.vnc
          PASS=$(tr -dc 'A-Za-z0-9!@#$%^&*' </dev/urandom | head -c 16)
          echo "$PASS" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          echo "VNC_PASSWORD=$PASS" >> "$GITHUB_ENV"
          cat > ~/.vnc/xstartup << 'EOF'
          #!/bin/bash
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          [ -r "$HOME/.Xresources" ] && xrdb "$HOME/.Xresources"
          export XDG_SESSION_TYPE=x11
          export GDK_BACKEND=x11
          export QT_QPA_PLATFORM=xcb
          exec dbus-launch /usr/bin/gnome-session --session=gnome
          EOF
          chmod +x ~/.vnc/xstartup
          vncserver -kill :0 || true
          vncserver :0 -localhost no -geometry 1280x800 -depth 24 -xstartup ~/.vnc/xstartup

      - name: Install Cloudflared
        run: |
          bash <(curl -fsSL https://raw.githubusercontent.com/cicybot/cloudflare-tunnel-proxy/refs/heads/main/install-cloudflared.sh)
          cloudflared -v
      - name: Establish Cloudflared Connection
        env:
          CF_TUNNEL: ${{ secrets.GA_UBUNTU_CF_TOKEN }}
        run: nohup cloudflared tunnel run --token $CF_TUNNEL > ~/tunnel.log 2>&1 &

      - name: Get npm cache directory
        id: npm-cache-dir
        run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - name: Restore npm cache
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: ${{ steps.npm-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Run Electron
        run: |
          git clone https://github.com/cicybot/electron-headless.git
          npm install electron -g
          cd electron-headless/app
          npm install
          electron -v
#          # Run Electron in background
#          nohup electron . > electron.log 2>&1 &
#
      - name: Docker 3proxy Proxy
        run: |
          docker run --name 3proxy --rm -d -p "8082:3128/tcp" ghcr.io/tarampampam/3proxy:1

      - name: Restore pip cache
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Jupyter and Run Jupyter in background
        env:
          JUPYTER_TOKEN: ${{ secrets.JUPYTER_TOKEN }}
        run: |
          pip install --upgrade pip
          pip install jupyterlab
          jupyter --version
          # Run Jupyter Lab in background
          nohup jupyter lab \
            --ServerApp.token=$JUPYTER_TOKEN \
            --ip=0.0.0.0 \
            --port=8888 \
            --ServerApp.allow_remote_access=True \
            --ServerApp.trust_xheaders=True \
            --no-browser > jupyter.log 2>&1 &

      - name: Maintain Connection
        run: |
          while true; do
            echo "=================="
            ps aux | grep jupyter
            ps aux | grep cloudflared
            docker ps
            sleep 10
          done
