name: Cache Test

on:
  push:
    branches:
      - main

jobs:
  cache-windows:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~\cicy
          key: test-cache-windows-v1

      - name: Show cache status
        shell: pwsh
        run: |
          if ("${{ steps.cache.outputs.cache-hit }}" -eq "true") {
            Write-Host "Cache HIT"
          } else {
            Write-Host "Cache MISS"
          }

      - name: Create folder and file when cache missing
        if: steps.cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force ~\cicy
          "Test cache (windows)" | Out-File ~\cicy\test.txt
          Write-Host "Created test cache file"

      - name: List contents of cache folder
        shell: pwsh
        run: |
          Write-Host "Listing ~\cicy"
          if (Test-Path ~\cicy) {
            Get-ChildItem ~\cicy -Recurse
          } else {
            Write-Host "Directory does not exist"
          }

  cache-ubuntu:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/cicy
          key: test-cache-ubuntu-v1

      - name: Show cache status
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "Cache HIT"
          else
            echo "Cache MISS"
          fi

      - name: Create folder and file when cache missing
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/cicy
          echo "Test cache (ubuntu)" > ~/cicy/test.txt
          echo "Created test cache file"

      - name: List contents of cache folder
        run: |
          echo "Listing ~/cicy"
          if [ -d ~/cicy ]; then
            ls -R ~/cicy
          else
            echo "Directory does not exist"
          fi
